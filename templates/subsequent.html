<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GPT-4-Composition</title>
    <link rel="stylesheet" href="/static/semantic-ui/semantic.min.css" />
    <link rel="stylesheet" href="/static/index.css" />
    <script src="/static/jquery/jquery.min.js"></script>
    <script src="/static/semantic-ui/semantic.min.js"></script>
  </head>
  <body>
    <div class="ui menu boarderless top">
      <div class="item">GPT-4-Composition</div>
      <a href="/" class="item">
        主页
      </a>
      <div class="ui dropdown item">
        <div class="text">现在开始</div>
        <i class="dropdown icon"></i>
        <div class="menu">
          <a href="/subsequent" class="item">读后续写优化</a>
        </div>
      </div>
    </div>
    <div class="ui container">
      <h4 class="ui block top attached header">
        <div class="content">读后续写优化</div>
      </h4>
      <div class="ui botton attached segment">
        <div class="ui form">
            <div class="field">
                <label>输入文章</label>
                <textarea rows="10"></textarea>
            </div>
            <button class="ui primary button" id="submit">
              提交
            </button>
        </div>
      </div>
      <div id="slow_message" class="ui message hidden">
        <div class="header">
          <i class="info icon"></i>ChatGPT 正在生成内容，这可能需要 1-2 分钟……
        </div>
      </div>
      <div id="error_message" class="ui negative message hidden">
        <div class="header">
          <i class="close icon"></i>
          <span id="error_text"></span>
        </div>
        <span id="error_detail"></span>
      </div>
    </div>
    <div class="ui vertical footer segment">
      <div class="ui center aligned container">
        <p>Made by <a href="https://lampese.com/about/">Lampese</a> and <a href="https://codezhangborui.com/">CodeZhangBorui</a></p>
        <p>
          Web Security Powered by
          <a href="https://www.geetest.com/" target="_blank">Geetest</a>
        </p>
      </div>
    </div>
    <script>
      $('.ui.dropdown')
        .dropdown()
      ;
    </script>
    <!-- Geetest Inital -->
    <script src="/static/gt4.min.js"></script>
    <script>
      var button = $('.ui.button#submit');
      var captchable = false;
      initGeetest4({
        captchaId: '{{ captcha_id }}',
        product: 'bind',
      }, function(captcha) {
        window.captcha = captcha;
        captcha.onReady(function() {
          captchable = true;
        }).onSuccess(function() {
          var result = captcha.getValidate();
          if(!result) {
            $("#error_text").text('请完成验证');
            $("#error_message").removeClass('hidden');
          }
          result.captcha_id = '{{ captcha_id }}';
          $('.ui.button#submit').addClass('loading');
          $("#slow_message").removeClass('hidden');
          $.ajax({
            url: '/api/subsequent/new',
            type: 'POST',
            timeout: 120000,
            dataType: 'json',
            data: {
              'composition': $('textarea').val(),
              'captcha_id': result['captcha_id'],
              'lot_number': result['lot_number'],
              'pass_token': result['pass_token'],
              'gen_time': result['gen_time'],
              'captcha_output': result['captcha_output']
            },
            success: function(data) {
              $(".ui.button#submit").removeClass('loading');
              if(data.status == 'error') {
                $("#error_text").text('错误');
                $("#error_detail").text(data.message);
                $("#error_message").removeClass('hidden');
              } else {
                $(".ui.button#submit").text = '成功!';
                $(".ui.button#submit").addClass('green');
                setTimeout(function() {
                  window.location = String(data.redirect);
                }, 1000);
              }
              $("#slow_message").addClass('hidden');
            },
          });
          
        }).onError(function() {
          $("#error_text").text('验证失败');
          $("#error_detail").text('验证码加载失败，请稍后重试。')
          $("#error_message").removeClass('hidden')
        })
      });
      button[0].addEventListener('click', function() {
        $("#error_message").addClass('hidden');
        if(captchable) {
          captcha.showBox();
        }
      });
    </script>
  </body>
</html>
